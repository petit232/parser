name: VPN Monster Auto-Update Ultimate

on:
  # 1. МГНОВЕННОЕ ОБНОВЛЕНИЕ: срабатывает при любом изменении ссылок или логики парсера
  push:
    branches:
      - main
    paths:
      - 'all_sources.txt'
      - 'parser.py'
      - '.github/workflows/monster_updater.yml'
  
  # 2. АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ: запуск каждые 6 часов (стандарт для поддержания актуальности)
  schedule:
    - cron: '0 */6 * * *'
  
  # 3. РУЧНОЙ ЗАПУСК: добавляет кнопку "Run workflow" во вкладке Actions
  workflow_dispatch:

jobs:
  build:
    name: Sync and Update Nodes
    runs-on: ubuntu-latest
    
    # Разрешения на запись контента обязательны для работы бота с файлами
    permissions:
      contents: write

    steps:
      # Шаг 1: Инициализация репозитория. fetch-depth: 0 нужен для корректного pull/rebase
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Шаг 2: Настройка стабильной версии Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Кэширование зависимостей для ускорения запусков

      # Шаг 3: Установка зависимостей с проверкой обновлений
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # Шаг 4: Запуск основного движка парсера
      # Мы добавляем удаление кэша перед запуском (если он вдруг мешает в системе)
      - name: Run Monster Parser Engine
        run: |
          # Принудительно удаляем временные файлы если они есть
          rm -f failed_nodes.txt.tmp 2>/dev/null
          python parser.py
        env:
          PYTHONUNBUFFERED: "1" # Чтобы логи отображались в реальном времени

      # Шаг 5: Финальная синхронизация (Fallback Sync)
      # Если скрипт отработал, но не смог запушить, этот шаг гарантирует сохранность данных
      - name: Final Git Sync and Push
        run: |
          git config --local user.email "bot@vpn-monster.com"
          git config --local user.name "VPN-Monster-Bot"
          
          # Убеждаемся, что мы на актуальной ветке и сбросили индекс
          git fetch origin main
          git checkout main
          
          # Добавляем все текстовые файлы. Используем -f чтобы точно подцепить всё
          git add *.txt
          
          # Если скрипт parser.py не сделал коммит, делаем его здесь
          if ! git diff --cached --quiet; then
            echo "Обнаружены изменения в файлах подписок. Фиксируем..."
            git commit -m "Ultra-Sync: $(date +'%Y-%m-%d %H:%M:%S') [Automated Update]"
            
            # Агрессивный пуш: пробуем до 5 раз с паузой и ребейзом
            MAX_RETRIES=5
            COUNT=0
            SUCCESS=false
            until [ $COUNT -eq $MAX_RETRIES ]; do
              if git push origin main; then
                SUCCESS=true
                break
              fi
              echo "Конфликт при пуше. Пробуем rebase... (Попытка $((COUNT + 1)))"
              git pull --rebase origin main
              COUNT=$((COUNT + 1))
              sleep 5
            done
            
            if [ "$SUCCESS" = false ]; then
              echo "Не удалось выполнить пуш после $MAX_RETRIES попыток."
              exit 1
            fi
          else
            echo "Git не обнаружил изменений в контенте .txt файлов."
            # Создаем пустой коммит раз в сутки, чтобы "оживить" GitHub Actions если нужно
            # Но здесь просто выходим, чтобы не спамить.
          fi
